<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Copydesk</title>

  <!-- shared Ascend CSS (from repo root) -->
  <link rel="stylesheet" href="../../assets/ascend.css">
  <link rel="stylesheet" href="../../assets/ascend-apps.css">
  <link rel="stylesheet" href="assets/ascend.css?v=2025-12-20-1708" />

</head>

<body class="ascend-app-body">
  <div class="ascend-app-shell">
    <div class="ascend-app-panel">

      <header class="ascend-app-header">
        <div class="ascend-app-title-block">
          <div class="ascend-app-subtitle">
            <span
              style="
                font-size: 2.4rem;
                font-weight: 300;
                letter-spacing: 0.04em;
              "
            >
              Copydesk
            </span>
          </div>
        </div>

      </header>

      <form class="ascend-app-form ascend-app-form--two-column" onsubmit="return false;">
        <label>
          Job Name
          <input type="text" id="jobName" value="" required placeholder="Job name" />
        </label>

        <label>
          Cutoff date
          <input type="date" id="cutoff" />
        </label>

        <label style="grid-column: 1 / -1;">
          Collaborators (comma-separated emails, optional)
          <input
            type="text"
            id="collaborators"
            placeholder="francesca@example.com, sarah@example.com"
          />
        </label>

        <label style="grid-column: 1 / -1;">
          Seed Text
          <textarea id="seedText" placeholder="Paste seed text here…"></textarea>
        </label>

        <div style="grid-column: 1 / -1;">
          <button id="submitBtn" type="button" class="ascend-app-primary-btn">
            Create job
          </button>

          <div id="status" style="margin-top: 10px;"></div>

          <details style="margin-top: 12px;">
            <summary style="cursor: pointer; user-select: none;">
              Response details
            </summary>
            <pre id="responseBox" style="margin-top: 10px;"></pre>
          </details>
        </div>
      </form>

      <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwW7nb_iJiZJBKeUIQtpp_GOY4tnLQidefDyOHqZDpQkfMympH2Ip4kvgv8bE1or9O9/exec';
        const jobNameInput = document.getElementById('jobName');
        const cutoffInput = document.getElementById('cutoff');
        const collaboratorsInput = document.getElementById('collaborators');
        const seedTextInput = document.getElementById('seedText');    
        const submitBtn = document.getElementById('submitBtn');
        const statusDiv = document.getElementById('status');
        const responseBox = document.getElementById('responseBox');

        // Pull logged-in user from URL (Ascend passes this through)
        const qs = new URLSearchParams(window.location.search || '');
        const userEmailFromUrl = (qs.get('user_email') || '').trim();

        function extractJobIdFromResponse(json) {
          if (!json || typeof json !== 'object') return '';
          return (
            json.jobid ||
            json.jobId ||
            json.id ||
            (json.data && (json.data.jobid || json.data.jobId || json.data.id)) ||
            (json.result && (json.result.jobid || json.result.jobId || json.result.id)) ||
            ''
          );
        }

        function normalizeCutoffToIso(raw) {
          if (!raw) return '';
          const s = raw.trim();
          if (!s) return '';

          // If it's already YYYY-MM-DD, keep it
          if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
            return s;
          }

          // Handle MM/DD/YYYY from the input
          const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
          if (m) {
            const mm = m[1].padStart(2, '0');
            const dd = m[2].padStart(2, '0');
            const yyyy = m[3];
            return `${yyyy}-${mm}-${dd}`;
          }

          // Fallback: send whatever it is
          return s;
        }

        async function createEnglishJob() {
          const jobName = jobNameInput.value.trim();
          if (!jobName) {
            statusDiv.textContent = 'Job name is required.';
            statusDiv.className = 'status-error';
            jobNameInput.focus();
            return;
          }
          const seedText = seedTextInput.value;

          const collaboratorsRaw = collaboratorsInput.value.trim();
          let collaborators = collaboratorsRaw
            ? collaboratorsRaw.split(',').map(s => s.trim()).filter(Boolean)
            : [];

          // Always include the logged-in Ascend user as a collaborator (hopper identity)
          if (userEmailFromUrl && collaborators.indexOf(userEmailFromUrl) === -1) {
            collaborators.unshift(userEmailFromUrl);
          }

          // Send the date exactly as chosen (e.g. "2025-12-02")
          const cutoff = normalizeCutoffToIso(cutoffInput.value);

          const params = new URLSearchParams(window.location.search);
          const user_email = params.get('user_email') || '';
          const user_name_first = params.get('user_name_first') || '';
          const user_name = params.get('user_name') || '';

          const payload = {
            action: 'createEnglishJob',
            jobName,
            seedText,
            cutoff,
            collaborators,
            user_email,
            user_name_first,
            user_name
          };

          statusDiv.textContent = 'Sending request…';
          statusDiv.className = '';
          responseBox.textContent = '';
          submitBtn.disabled = true;

          try {
            const res = await fetch(API_URL, {
              method: 'POST',
              // text/plain avoids CORS preflight; Apps Script often fails OPTIONS.
              headers: { 'Content-Type': 'text/plain;charset=utf-8' },
              body: JSON.stringify(payload)
            });

            const text = await res.text();
            let json;

            try {
              json = JSON.parse(text);
            } catch (e) {
              json = { parseError: e.toString(), raw: text };
            }

            if (json.ok) {
              statusDiv.textContent = 'Job created successfully ✅';
              statusDiv.className = 'status-ok';

              // Wire the chain: open the job view with the returned jobId (authoritative API contract)
              const jobId = extractJobIdFromResponse(json);
              if (jobId) {
                // Persist for "resume last job" convenience
                try { localStorage.setItem('copydesk_last_jobid', jobId); } catch (e) {}

                // Navigate this tab (no popup blockers)
                const next = new URL(
                  `job.html?jobid=${encodeURIComponent(jobId)}`,
                  window.location.href
                );
                if (userEmailFromUrl) next.searchParams.set('user_email', userEmailFromUrl);
                window.location.href = next.toString();
                return;
              } else {
                statusDiv.textContent = 'Job created, but no jobId was returned ❌';
                statusDiv.className = 'status-error';
              }
            } else {
              statusDiv.textContent = 'API returned an error ❌';
              statusDiv.className = 'status-error';
            }

            responseBox.textContent = JSON.stringify(json, null, 2);
          } catch (err) {
            statusDiv.textContent = 'Request failed ❌';
            statusDiv.className = 'status-error';
            responseBox.textContent = err.toString();
          } finally {
            submitBtn.disabled = false;
          }
        }

        submitBtn.addEventListener('click', () => {
          createEnglishJob();
        });
      </script>

    </div>
  </div>
</body>
</html>